# ðŸš€ Vercel Staging Deployment - Step by Step

**Time Required**: 10-15 minutes  
**Status**: Ready to Deploy  
**Date**: January 4, 2026  

---

## ðŸ“‹ Prerequisites Checklist

Before you start:

- [x] Vercel CLI installed
- [ ] Vercel account created (https://vercel.com/signup)
- [ ] GitHub/GitLab account linked to Vercel
- [ ] Staging Strapi URL ready
- [ ] Strapi API token generated
- [ ] Webhook secret generated

---

## ðŸ” Generate Required Secrets

Open a terminal and generate the required secrets:

```bash
# Generate webhook signing secret (32 hex characters)
openssl rand -hex 32

# Generate ISR revalidation secret (32 hex characters)
openssl rand -hex 32
```

Save these values - you'll need them in the next step.

---

## ðŸ“ Step 1: Create Environment File (2 minutes)

Copy the staging environment template and customize it:

```bash
cp .env.staging .env.staging.local
nano .env.staging.local
```

Update these values with your actual staging setup:

```bash
# Staging URLs (update with your actual domains)
NEXT_PUBLIC_APP_URL=https://your-staging-url.vercel.app
NEXT_PUBLIC_STRAPI_URL=https://your-staging-strapi-url.com

# API Token from Strapi
STRAPI_TOKEN=your_actual_strapi_api_token

# Secrets (use the values generated above)
STRAPI_WEBHOOK_SECRET=paste_your_generated_webhook_secret_here
ISR_REVALIDATE_SECRET=paste_your_generated_isr_secret_here

# Endpoints (will be auto-generated by Vercel)
NEXT_PUBLIC_WEBHOOK_ENDPOINT=https://your-staging-url.vercel.app/api/webhooks/strapi
NEXT_PUBLIC_REVALIDATION_ENDPOINT=https://your-staging-url.vercel.app/api/revalidate

# Database (if using Supabase)
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
```

Save the file: `Ctrl+O`, `Enter`, `Ctrl+X`

---

## ðŸ”‘ Step 2: Vercel Authentication (2 minutes)

Authenticate with Vercel:

```bash
vercel login
```

This will:
1. Open your browser to Vercel
2. Ask you to confirm authentication
3. Return to terminal when complete

Verify:
```bash
vercel whoami
```

---

## ðŸ—ï¸ Step 3: Link Project to Vercel (3 minutes)

Link your project to Vercel:

```bash
vercel link
```

When prompted:
- **Set up new project?** â†’ `y` (yes)
- **What's your project's name?** â†’ `insurance-website-staging` (or your preferred name)
- **In which directory is your code?** â†’ `.` (current directory)
- **Want to modify vercel.json?** â†’ `n` (no)

This creates `.vercel/project.json` (add to `.gitignore` if using git)

---

## ðŸ“¤ Step 4: Deploy to Staging (5 minutes)

Deploy with environment variables:

```bash
vercel deploy --env-file=.env.staging.local
```

This will:
1. Build your Next.js application
2. Optimize all pages and API routes
3. Deploy to Vercel infrastructure
4. Return your staging URL

**Output will look like:**
```
âœ… Production: https://insurance-website-staging.vercel.app
âœ… Preview: https://insurance-website-staging-[hash].vercel.app
```

**Keep this URL** - you'll need it for webhook configuration!

---

## âœ… Step 5: Verify Staging Deployment (3 minutes)

Test that staging is working:

```bash
# Replace with your actual staging URL
STAGING_URL="https://insurance-website-staging.vercel.app"

# Test homepage
curl -I $STAGING_URL

# Test health endpoint
curl $STAGING_URL/api/webhooks/strapi
```

Expected responses:
- Homepage: `HTTP/1.1 200 OK`
- Webhook endpoint: `HTTP/1.1 400 Bad Request` (expected - no signature)

---

## ðŸ”— Step 6: Configure Strapi Webhooks (5 minutes)

Now configure webhooks in your staging Strapi instance:

1. **Log in to Strapi Admin**:
   - Navigate to your staging Strapi URL
   - Login with your credentials

2. **Create Webhook**:
   - Settings â†’ Webhooks â†’ Create new webhook
   - **Name**: `Insurance Website Cache Invalidation`
   - **URL**: `https://your-staging-url.vercel.app/api/webhooks/strapi`
   - **Headers** (add custom header):
     - Key: `X-Strapi-Webhook-Secret`
     - Value: Paste your `STRAPI_WEBHOOK_SECRET` value

3. **Select Events** (enable all):
   - [ ] Entry Publish
   - [ ] Entry Unpublish
   - [ ] Entry Create
   - [ ] Entry Update
   - [ ] Entry Delete

4. **Save** the webhook

---

## ðŸ§ª Step 7: Test Webhook (5 minutes)

Test that webhooks are working:

```bash
# Create a test file with your values
cat > /tmp/test_webhook.sh << 'EOF'
#!/bin/bash

STAGING_URL="https://your-staging-url.vercel.app"
WEBHOOK_SECRET="your_webhook_secret_here"
EVENT_TYPE="entry.publish"

# Generate timestamp and signature
TIMESTAMP=$(date +%s)
SIGNATURE=$(echo -n "{\"timestamp\":$TIMESTAMP}" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

# Send test webhook
curl -X POST "$STAGING_URL/api/webhooks/strapi" \
  -H "Content-Type: application/json" \
  -H "X-Strapi-Webhook-Secret: $WEBHOOK_SECRET" \
  -d '{
    "event": "'$EVENT_TYPE'",
    "createdAt": "'$(date -Iseconds)'",
    "model": "blog",
    "entry": {"id": 1, "title": "Test"}
  }'
EOF

chmod +x /tmp/test_webhook.sh
/tmp/test_webhook.sh
```

Expected response: `200 OK` with cache invalidation message

---

## ðŸ“Š Staging Deployment Complete! âœ…

Your staging environment is now live:

| Component | Status | URL |
|-----------|--------|-----|
| Frontend | âœ… Deployed | `https://your-staging-url.vercel.app` |
| Webhooks | âœ… Configured | Ready to receive events |
| ISR Cache | âœ… Enabled | Tag/path-based invalidation |
| Database | âœ… Connected | Using Supabase |

---

## ðŸ“‹ Summary of What Was Done

1. âœ… Vercel CLI installed
2. âœ… Environment variables configured
3. âœ… Project linked to Vercel
4. âœ… Application deployed to staging
5. âœ… Webhooks configured in Strapi
6. âœ… Integration tested

---

## ðŸ”§ Useful Vercel Commands

Monitor your deployment:

```bash
# View deployment status
vercel status

# View logs
vercel logs

# Redeploy latest
vercel deploy --prod

# List all deployments
vercel list
```

---

## âš ï¸ Troubleshooting

### Deployment Failed

```bash
# Check build locally
npm run build

# Deploy with verbose output
vercel deploy --debug
```

### Webhook Not Working

```bash
# Check webhook logs in Vercel
vercel logs --filter webhook

# Verify endpoint
curl https://your-staging-url.vercel.app/api/webhooks/strapi
```

### Environment Variables Not Loaded

```bash
# Redeploy with env file
vercel deploy --env-file=.env.staging.local --prod

# Check Vercel dashboard â†’ Settings â†’ Environment Variables
```

---

## âœ¨ Next Steps

Now that staging is deployed, you're ready to:

1. **Run Integration Tests** (65 minutes)
   - Use [STAGING_INTEGRATION_TESTING.md](STAGING_INTEGRATION_TESTING.md)
   - Test all webhook scenarios
   - Verify cache invalidation
   - E2E content sync testing

2. **Phase 5: Production Planning** (1-2 hours)
   - Create production deployment files
   - Configure monitoring & security
   - Prepare go-live checklist

---

## ðŸ“ž Need Help?

**Deployment Issues?**
- Check Vercel dashboard: https://vercel.com/dashboard
- View build logs
- Re-run deployment

**Webhook Issues?**
- Verify webhook secret matches
- Check Strapi webhook logs
- Review /api/webhooks/strapi logs in Vercel

**Environment Variable Issues?**
- Ensure all secrets are set in Vercel dashboard
- Redeploy after setting variables
- Check `.env.staging.local` is correct

---

**Status**: âœ… STAGING DEPLOYED  
**Next**: Run integration tests with [STAGING_INTEGRATION_TESTING.md](STAGING_INTEGRATION_TESTING.md)  
**Timeline**: Ready for testing immediately

